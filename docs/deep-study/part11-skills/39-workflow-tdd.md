# Chapter 39: çº¢ç»¿ç¯å®ˆæŠ¤è€… â€” workflow-tdd çš„é“å¾‹æ‰§è¡Œ

> **ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ**: æµ‹è¯•å…ˆè¡Œ â†’ ä»£ç å®ç° â†’ é‡æ„ä¼˜åŒ–
> **æ¶‰åŠèµ„äº§**: workflow-tdd Skill + TDD Iron Law + Red-Green-Refactor
> **é˜…è¯»æ—¶é—´**: 55-70 åˆ†é’Ÿ
> **ç‰ˆæœ¬è¿½è¸ª**: `.claude/skills/workflow-tdd/SKILL.md`

---

## 0. èµ„äº§è¯è¨€ (Asset Testimony)

> *"æˆ‘æ˜¯ `workflow-tdd`ã€‚äººä»¬å«æˆ‘'çº¢ç»¿ç¯å®ˆæŠ¤è€…'â€”â€”å› ä¸ºæˆ‘å®ˆæŠ¤ç€æœ€ç¥åœ£çš„æ³•åˆ™ã€‚"*
>
> *"é“å¾‹æ˜¯åˆ»åœ¨æˆ‘åŸºå› é‡Œçš„ï¼šNO PRODUCTION CODE WITHOUT A FAILING TEST FIRSTã€‚"*
>
> *"æˆ‘æœ‰ä¸‰ä¸ªé˜¶æ®µï¼šçº¢ç¯ï¼ˆæµ‹è¯•å¤±è´¥ï¼‰ã€ç»¿ç¯ï¼ˆæµ‹è¯•é€šè¿‡ï¼‰ã€é‡æ„ï¼ˆä¼˜åŒ–ä»£ç ï¼‰ã€‚è¿™ä¸‰ä¸ªé˜¶æ®µå¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œä¸èƒ½è·³è¿‡ï¼Œä¸èƒ½ä¹±åºã€‚çº¢ç¯æ˜¯èµ·ç‚¹ï¼Œç»¿ç¯æ˜¯ç»ˆç‚¹ï¼Œé‡æ„æ˜¯å‡åã€‚"*
>
> *"...ä½†æœ€è¿‘ï¼Œæˆ‘å‘ç°äº†ä¸€ç§'å‡çº¢ç¯'ç°è±¡ã€‚æœ‰äº›å¼€å‘è€…åœ¨å†™æµ‹è¯•æ—¶ï¼Œæ•…æ„è®©æµ‹è¯•å¤±è´¥â€”â€”ä¸æ˜¯å› ä¸ºä»£ç ä¸å­˜åœ¨ï¼Œè€Œæ˜¯å› ä¸ºä»–ä»¬åœ¨æµ‹è¯•é‡Œå†™äº† `expect(true).toBe(false)`ã€‚ä»–ä»¬ä»¥ä¸ºè¿™æ ·å°±èƒ½é€šè¿‡æˆ‘çš„æ£€æŸ¥..."*

```markdown
è°ƒæŸ¥è¿›åº¦: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 53%
å¹½çµä½ç½®: Skills å±‚ â€” workflow-tdd
æœ¬ç« çº¿ç´¢: æµ‹è¯•ç«‹å³é€šè¿‡ï¼ˆæœªè§è¯ Red é˜¶æ®µï¼‰
           â””â”€â”€ å¼€å‘è€…ç»•è¿‡é“å¾‹ï¼šå…ˆå†™ä»£ç åè¡¥æµ‹è¯•
           â””â”€â”€ å‡çº¢ç¯ï¼šæµ‹è¯•æ•…æ„å¤±è´¥ï¼Œä»£ç å·²å­˜åœ¨
           â””â”€â”€ éšè—å‡è®¾ Bugï¼šæµ‹è¯•è¦†ç›–äº†ä»£ç ï¼Œæ²¡è¦†ç›–æ„å›¾
```

---

## è‹æ ¼æ‹‰åº•å¼æ€è€ƒ

> **Q1**: ä¸ºä»€ä¹ˆæµ‹è¯•å¿…é¡»åœ¨ä»£ç ä¹‹å‰ï¼Ÿ

åœ¨çœ‹ä»£ç ä¹‹å‰ï¼Œå…ˆæ€è€ƒï¼š
1. "å…ˆå†™ä»£ç åè¡¥æµ‹è¯•"æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ
2. æµ‹è¯•å¤±è´¥çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ
3. å¦‚æœæµ‹è¯•ç«‹å³é€šè¿‡ï¼Œæ„å‘³ç€ä»€ä¹ˆï¼Ÿ

---

> **æ¶æ„é™·é˜± 39.1**: æ—¢ç„¶æµ‹è¯•å’Œä»£ç éƒ½å†™äº†ï¼Œé¡ºåºé‡è¦å—ï¼Ÿåªè¦æœ€ç»ˆæµ‹è¯•é€šè¿‡ï¼Œç»“æœä¸éƒ½ä¸€æ ·å—ï¼Ÿ
>
> **é™·é˜±æ–¹æ¡ˆ**: å…è®¸"å…ˆå†™ä»£ç åè¡¥æµ‹è¯•"ï¼Œåªè¦æµ‹è¯•é€šè¿‡å°±è¡Œã€‚
>
> **æ€è€ƒç‚¹**:
> - æœ€ç»ˆç»“æœéƒ½æ˜¯"æµ‹è¯•é€šè¿‡"ï¼Œä¸ºä»€ä¹ˆè¿‡ç¨‹é‡è¦ï¼Ÿ
> - æµ‹è¯•å¤±è´¥çœŸçš„æœ‰é‚£ä¹ˆé‡è¦å—ï¼Ÿ
> - TDD çš„æ ¸å¿ƒä»·å€¼æ˜¯ä»€ä¹ˆï¼Ÿ
>
> <details>
> <summary>**æ­ç¤ºé™·é˜±**</summary>
>
> **è‡´å‘½ç¼ºé™· 1ï¼šæµ‹è¯•ä»·å€¼ä¸§å¤±**
>
> ```
> åœºæ™¯ A: TDDï¼ˆå…ˆå†™æµ‹è¯•ï¼‰
> 1. å†™æµ‹è¯•: expect(add(1, 2)).toBe(3)
> 2. è¿è¡Œæµ‹è¯•: FAIL (add is not defined)
> 3. å†™ä»£ç : function add(a, b) { return a + b; }
> 4. è¿è¡Œæµ‹è¯•: PASS
> 
> æµ‹è¯•ä»·å€¼: éªŒè¯äº† add å‡½æ•°ç¬¦åˆé¢„æœŸ
> 
> åœºæ™¯ B: å…ˆå†™ä»£ç åè¡¥æµ‹è¯•
> 1. å†™ä»£ç : function add(a, b) { return a + b; }
> 2. è¡¥æµ‹è¯•: expect(add(1, 2)).toBe(3)
> 3. è¿è¡Œæµ‹è¯•: PASS
> 
> é—®é¢˜: å¦‚æœä»£ç æœ‰ Bug å‘¢ï¼Ÿ
> 1. å†™ä»£ç : function add(a, b) { return a - b; }  // Bug!
> 2. è¡¥æµ‹è¯•: expect(add(1, 2)).toBe(-1)  // é”™è¯¯çš„é¢„æœŸï¼
> 3. è¿è¡Œæµ‹è¯•: PASS  // æµ‹è¯•é€šè¿‡ï¼Œä½†ä»£ç æ˜¯é”™çš„ï¼
> 
> æµ‹è¯•ä»·å€¼: éªŒè¯äº† Bug çš„å­˜åœ¨ï¼Œè€Œä¸æ˜¯éªŒè¯åŠŸèƒ½çš„æ­£ç¡®
> ```
>
> **è‡´å‘½ç¼ºé™· 2ï¼šè¾¹ç¼˜æ¡ˆä¾‹é—æ¼**
>
> ```
> TDD æ¨¡å¼:
> 1. æƒ³æµ‹è¯•: add(1, 2) = 3
> 2. æƒ³æµ‹è¯•: add(-1, 1) = 0
> 3. æƒ³æµ‹è¯•: add(0, 0) = 0
> 4. æƒ³æµ‹è¯•: add(1.5, 2.5) = 4
> 5. å¼€å§‹å†™ä»£ç ï¼Œç¡®ä¿æ‰€æœ‰åœºæ™¯éƒ½è¦†ç›–
> 
> å…ˆå†™ä»£ç åè¡¥æµ‹è¯•æ¨¡å¼:
> 1. å†™ä»£ç : function add(a, b) { return a + b; }
> 2. çœ‹ä»£ç : "è¿™ä¸ªå‡½æ•°çœ‹èµ·æ¥æ²¡é—®é¢˜"
> 3. è¡¥æµ‹è¯•: expect(add(1, 2)).toBe(3)  // åªæµ‹ä¸€ä¸ªåœºæ™¯
> 4. é—æ¼: è´Ÿæ•°ã€é›¶ã€æµ®ç‚¹æ•°...
> 
> ä¸ºä»€ä¹ˆä¼šé—æ¼ï¼Ÿ
> å› ä¸º"çœ‹ä»£ç å†™æµ‹è¯•"ä¼šå—é™äºä½œè€…çš„æƒ³è±¡
> è€Œ"å†™æµ‹è¯•é©±åŠ¨ä»£ç "ä¼šå¼ºè¿«æ€è€ƒæ‰€æœ‰å¯èƒ½çš„è¾“å…¥
> ```
>
> **è‡´å‘½ç¼ºé™· 3ï¼šè®¾è®¡åé¦ˆä¸¢å¤±**
>
> ```
> TDD æ¨¡å¼:
> 1. å†™æµ‹è¯•: expect(user.login("password")).toBe(true)
> 2. æ„è¯†åˆ°: "ç­‰ç­‰ï¼Œå¯†ç ä¸åº”è¯¥æ˜¯æ˜æ–‡"
> 3. ä¿®æ”¹æµ‹è¯•: expect(user.login(hash("password"))).toBe(true)
> 4. å†™ä»£ç : å®ç°å“ˆå¸ŒéªŒè¯
> 
> å…ˆå†™ä»£ç åè¡¥æµ‹è¯•æ¨¡å¼:
> 1. å†™ä»£ç : æ˜æ–‡å¯†ç éªŒè¯
> 2. è¡¥æµ‹è¯•: expect(user.login("password")).toBe(true)
> 3. æµ‹è¯•é€šè¿‡
> 4. å®‰å…¨é—®é¢˜è¢«"é—å¿˜"
> 
> æµ‹è¯•å…ˆè¡Œçš„ä»·å€¼: åœ¨å†™ä»£ç å‰å‘ç°è®¾è®¡é—®é¢˜
> æµ‹è¯•åè¡¥çš„é—®é¢˜: ä»£ç å·²ç»å†™å¥½ï¼Œæ”¹èµ·æ¥æœ‰å¿ƒç†é˜»åŠ›
> ```
>
> **æ­£ç¡®çš„è®¾è®¡**:
>
> ```
> TDD Iron Law:
> 
> NO PRODUCTION CODE WITHOUT A FAILING TEST FIRST
> 
> å«ä¹‰:
> 1. å¿…é¡»å…ˆå†™æµ‹è¯•
> 2. æµ‹è¯•å¿…é¡»å¤±è´¥ï¼ˆè¯æ˜æµ‹è¯•æœ‰æ•ˆï¼‰
> 3. åªå†™èƒ½è®©æµ‹è¯•é€šè¿‡çš„æœ€å°‘ä»£ç 
> 4. é€šè¿‡åå†é‡æ„
> 
> è¿™ä¸æ˜¯"æ•™æ¡"ï¼Œè€Œæ˜¯"ä¿æŠ¤æœºåˆ¶"
> ```
>
> </details>

---

## ç¬¬ä¸€å¹•ï¼šå¤±æ§çš„è¾¹ç¼˜ (Out of Control)

### æ²¡æœ‰ TDD çš„ä¸–ç•Œ

æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœé¡¹ç›®æ²¡æœ‰ `workflow-tdd`ï¼š

```markdown
å¼€å‘è€… A: "æˆ‘è¦å®ç°ä¸€ä¸ªæ’åºåŠŸèƒ½"

å¼€å‘è€… A çš„æ“ä½œ:
1. å†™ä»£ç : function sort(arr) { return arr.sort(); }
2. æ‰‹åŠ¨æµ‹è¯•: sort([3, 1, 2]) â†’ [1, 2, 3] âœ“
3. æäº¤ä»£ç 

[ä¸€å‘¨å]

å¼€å‘è€… B: "æ’åºåŠŸèƒ½æœ‰ Bug"
å¼€å‘è€… A: "ä»€ä¹ˆ Bugï¼Ÿ"
å¼€å‘è€… B: "sort([10, 2, 1]) â†’ [1, 10, 2]"

åŸå› : JavaScript çš„ sort() é»˜è®¤æ˜¯å­—ç¬¦ä¸²æ’åº
é—®é¢˜: æ²¡æœ‰æµ‹è¯•è¦†ç›–æ•°å­—æ’åºåœºæ™¯

[ä¸€ä¸ªæœˆå]

å¼€å‘è€… C: "æ’åºåˆæœ‰ Bug äº†"
å¼€å‘è€… A: "è¿™æ¬¡æ˜¯ä»€ä¹ˆï¼Ÿ"
å¼€å‘è€… C: "sort([]) â†’ å´©æºƒ"

åŸå› : ç©ºæ•°ç»„æ²¡æœ‰ç‰¹æ®Šå¤„ç†
é—®é¢˜: æ²¡æœ‰æµ‹è¯•è¦†ç›–è¾¹ç•Œæƒ…å†µ

[ä¸‰ä¸ªæœˆå]

ä»£ç åº“ä¸­ç§¯ç´¯äº† 17 ä¸ª"ä¸´æ—¶ä¿®å¤"ï¼Œæ’åºå‡½æ•°å˜å¾—ä¸å¯è¯»
```

**é—®é¢˜æœ¬è´¨**: æ²¡æœ‰"æµ‹è¯•å…ˆè¡Œ"çš„å¼€å‘ï¼Œå°±æ˜¯"ç›²äººéª‘çé©¬"ã€‚

### Red-Green-Refactor å¾ªç¯

`workflow-tdd` çš„ä¸‰é˜¶æ®µå¾ªç¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    çº¢ç»¿ç¯å®ˆæŠ¤è€…çš„å¾ªç¯                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ ğŸ”´ RED Phase (çº¢ç¯é˜¶æ®µ)                 â”‚               â”‚
â”‚  â”‚                                         â”‚               â”‚
â”‚  â”‚ 1. å†™ä¸€ä¸ªå¤±è´¥çš„æµ‹è¯•                     â”‚               â”‚
â”‚  â”‚    - æµ‹è¯•æè¿°é¢„æœŸè¡Œä¸º                   â”‚               â”‚
â”‚  â”‚    - è¿è¡Œæµ‹è¯• â†’ FAIL                   â”‚               â”‚
â”‚  â”‚                                         â”‚               â”‚
â”‚  â”‚ ç›®çš„: è¯æ˜æµ‹è¯•æœ‰æ•ˆ                      â”‚               â”‚
â”‚  â”‚       å®šä¹‰"å®Œæˆ"çš„æ ‡å‡†                  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ ğŸŸ¢ GREEN Phase (ç»¿ç¯é˜¶æ®µ)               â”‚               â”‚
â”‚  â”‚                                         â”‚               â”‚
â”‚  â”‚ 2. å†™æœ€å°‘ä»£ç è®©æµ‹è¯•é€šè¿‡                 â”‚               â”‚
â”‚  â”‚    - ä¸è¿½æ±‚å®Œç¾                         â”‚               â”‚
â”‚  â”‚    - åªæ±‚é€šè¿‡                           â”‚               â”‚
â”‚  â”‚    - è¿è¡Œæµ‹è¯• â†’ PASS                   â”‚               â”‚
â”‚  â”‚                                         â”‚               â”‚
â”‚  â”‚ ç›®çš„: è®©åŠŸèƒ½å·¥ä½œ                        â”‚               â”‚
â”‚  â”‚       å»ºç«‹ä¿¡å¿ƒ                          â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ ğŸ”µ REFACTOR Phase (é‡æ„é˜¶æ®µ)            â”‚               â”‚
â”‚  â”‚                                         â”‚               â”‚
â”‚  â”‚ 3. ä¼˜åŒ–ä»£ç ç»“æ„                         â”‚               â”‚
â”‚  â”‚    - æ¶ˆé™¤é‡å¤                           â”‚               â”‚
â”‚  â”‚    - æ”¹å–„å‘½å                           â”‚               â”‚
â”‚  â”‚    - ç®€åŒ–é€»è¾‘                           â”‚               â”‚
â”‚  â”‚    - è¿è¡Œæµ‹è¯• â†’ PASS (ä¿æŒç»¿ç¯)        â”‚               â”‚
â”‚  â”‚                                         â”‚               â”‚
â”‚  â”‚ ç›®çš„: æé«˜ä»£ç è´¨é‡                      â”‚               â”‚
â”‚  â”‚       æŠ€æœ¯å€ºåŠ¡æ¸…ç†                      â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚  å¾ªç¯: å›åˆ° RED Phaseï¼Œå†™ä¸‹ä¸€ä¸ªæµ‹è¯•                          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¬¬äºŒå¹•ï¼šæ€ç»´è„‰ç»œ (The Neural Link)

### 2.1 TDD Iron Law æ‰§è¡Œ

**é“å¾‹å®šä¹‰**:

```yaml
TDD Iron Law:
  rule: NO PRODUCTION CODE WITHOUT A FAILING TEST FIRST
  
  enforcement:
    - phase_5: implementation å¿…é¡»åŒ…å« Red-Green-Refactor ä¸‰æ­¥
    - phase_6: éªŒè¯ Red é˜¶æ®µå­˜åœ¨ï¼ˆæµ‹è¯•å¤±è´¥æ—¥å¿—ï¼‰
    - violation: æ ‡è®°ä¸º TDD_NON_COMPLIANTï¼Œéœ€è¦äººå·¥ç¡®è®¤
```

**åˆè§„æ£€æŸ¥ç‚¹**:

| Checkpoint | Validation Phase | Evidence Required |
|------------|------------------|-------------------|
| Test-first structure | Phase 5 | `implementation` has 3 steps |
| Red phase exists | Phase 6 | Step 1: `tdd_phase: "red"` + FAIL log |
| Green phase with test-fix | Phase 6 | Step 2: `tdd_phase: "green"` + PASS log |
| Refactor phase exists | Phase 6 | Step 3: `tdd_phase: "refactor"` + no regression |

### 2.2 ä»»åŠ¡ç»“æ„æ¨¡æ¿

**TDD ä»»åŠ¡çš„å†…éƒ¨ç»“æ„**:

```json
{
  "id": "IMPL-001",
  "title": "Implement user authentication",
  "implementation": [
    {
      "step": 1,
      "tdd_phase": "red",
      "description": "Write failing test for login",
      "commands": [
        "Write test file: tests/auth/login.test.ts",
        "Run test: npm test -- login.test.ts",
        "Verify: FAIL (function not implemented)"
      ]
    },
    {
      "step": 2,
      "tdd_phase": "green",
      "description": "Implement login to pass test",
      "commands": [
        "Write code: src/auth/login.ts",
        "Run test: npm test -- login.test.ts",
        "Verify: PASS"
      ],
      "test_fix_cycle": {
        "max_iterations": 3,
        "on_failure": "auto_revert"
      }
    },
    {
      "step": 3,
      "tdd_phase": "refactor",
      "description": "Optimize login implementation",
      "commands": [
        "Refactor: extract validation logic",
        "Run test: npm test -- login.test.ts",
        "Verify: PASS (no regression)"
      ]
    }
  ]
}
```

### 2.3 è‡ªåŠ¨å›é€€æœºåˆ¶

**Green Phase çš„è‡ªåŠ¨å›é€€**:

```javascript
// Phase 5 - Green Phase æ‰§è¡Œ
async function executeGreenPhase(task) {
  const maxIterations = task.test_fix_cycle.max_iterations || 3;
  
  for (let i = 0; i < maxIterations; i++) {
    // æ‰§è¡Œä»£ç ä¿®æ”¹
    await executeImplementation(task);
    
    // è¿è¡Œæµ‹è¯•
    const result = await runTests(task.test_file);
    
    if (result.passed) {
      return { success: true, iterations: i + 1 };
    }
    
    // æµ‹è¯•å¤±è´¥ï¼Œå°è¯•ä¿®å¤
    if (i < maxIterations - 1) {
      await analyzeAndFix(result.failures);
    }
  }
  
  // è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œè‡ªåŠ¨å›é€€
  if (task.test_fix_cycle.on_failure === 'auto_revert') {
    await revertToLastWorkingState();
    return { success: false, reason: 'Max iterations reached, auto-reverted' };
  }
}
```

---

## ç¬¬ä¸‰å¹•ï¼šç¤¾äº¤ç½‘ç»œ (The Social Network)

### TDD ä¸å…¶ä»– Skills çš„å…³ç³»

```mermaid
graph TB
    A[workflow-tdd] --> B[workflow-test-fix]
    A --> C[workflow-plan]
    A --> D[review-cycle]
    
    C -->|ç”Ÿæˆ TDD ä»»åŠ¡| A
    A -->|æ‰§è¡Œåæµ‹è¯•å¤±è´¥| B
    A -->|ä»£ç å®¡æŸ¥| D
    
    B -->|ä¿®å¤å¾ªç¯| A
    D -->|è´¨é‡é—®é¢˜| A
```

### Agent è§’è‰²

| Agent | TDD Phase | Responsibility |
|-------|-----------|----------------|
| `@code-developer` | Red, Green, Refactor | æµ‹è¯•ä¸ä»£ç ç¼–å†™ |
| `@test-fix-agent` | Green (fix cycle) | æµ‹è¯•å¤±è´¥ä¿®å¤ |
| `@cli-planning-agent` | Refactor (analysis) | é‡æ„åˆ†æ |

---

## ç¬¬å››å¹•ï¼šé€ ç‰©ä¸»çš„ç§è¯­ (The Creator's Secret)

### ç§˜å¯†ä¸€ï¼šä¸ºä»€ä¹ˆ"å‡çº¢ç¯"æ˜¯å±é™©çš„ï¼Ÿ

```markdown
å‡çº¢ç¯: æµ‹è¯•æ•…æ„å¤±è´¥ï¼Œä½†ä»£ç å·²å­˜åœ¨

// æµ‹è¯•æ–‡ä»¶
it('should add numbers', () => {
  expect(true).toBe(false);  // æ•…æ„å¤±è´¥
});

// è¿è¡Œç»“æœ
FAIL: expected true to be false

// å¼€å‘è€…è®¤ä¸º: "çº¢ç¯äº†ï¼Œå¯ä»¥å†™ä»£ç äº†"

// ç„¶åä¿®æ”¹æµ‹è¯•
it('should add numbers', () => {
  expect(add(1, 2)).toBe(3);  // ç°åœ¨æ‰çœŸæ­£æµ‹è¯•
});

// è¿è¡Œç»“æœ
PASS

é—®é¢˜:
1. ç¬¬ä¸€ä¸ªçº¢ç¯ä¸æ˜¯"çœŸçº¢ç¯"
2. å®ƒæ²¡æœ‰éªŒè¯æµ‹è¯•çš„æœ‰æ•ˆæ€§
3. add(1, 2) === 3 å¯èƒ½å·²ç»æ˜¯æ­£ç¡®çš„
4. æ²¡æœ‰ç»å†è¿‡"æµ‹è¯•é©±åŠ¨"çš„è¿‡ç¨‹

çœŸæ­£çš„çº¢ç¯:
- æµ‹è¯•å¤±è´¥æ˜¯å› ä¸ºä»£ç ä¸å­˜åœ¨æˆ–è¡Œä¸ºä¸æ­£ç¡®
- ä¸æ˜¯å› ä¸ºæµ‹è¯•æœ¬èº«æ•…æ„å†™é”™
```

### ç§˜å¯†äºŒï¼šéšè—å‡è®¾ Bug

```markdown
æµ‹è¯•è¦†ç›–äº†ä»£ç ï¼Œä½†æ²¡è¦†ç›–æ„å›¾

// ä»£ç 
function validateEmail(email) {
  return email.includes('@');
}

// æµ‹è¯•
it('validates email', () => {
  expect(validateEmail('test@example.com')).toBe(true);
  expect(validateEmail('invalid')).toBe(false);
});

// æµ‹è¯•é€šè¿‡ï¼Œè¦†ç›–ç‡ 100%

// éšè—çš„é—®é¢˜:
// - 'test@' ä¼šè¿”å› trueï¼Œä½†ä¸æ˜¯æœ‰æ•ˆé‚®ç®±
// - '@example.com' ä¼šè¿”å› trueï¼Œä½†ä¸æ˜¯æœ‰æ•ˆé‚®ç®±
// - æµ‹è¯•è¦†ç›–äº†"ä»£ç çš„è¡Œä¸º"ï¼Œæ²¡è¦†ç›–"é‚®ç®±çš„æœ‰æ•ˆæ€§"

TDD çš„ä¿æŠ¤:
- å¦‚æœå…ˆå†™æµ‹è¯•ï¼Œä¼šå…ˆæ€è€ƒ"ä»€ä¹ˆæ˜¯æœ‰æ•ˆé‚®ç®±"
- ä¼šå†™å‡ºæ›´å¤šçš„è¾¹ç•Œæµ‹è¯•
- ä¼šå‘ç° includes('@') ä¸å¤Ÿä¸¥æ ¼
```

---

## ç¬¬äº”å¹•ï¼šè¿›åŒ–çš„æ’æ§½ (The Upgrade)

### æ’æ§½ä¸€ï¼šè‡ªå®šä¹‰ TDD æ¨¡æ¿

```yaml
# å½“å‰: æ ‡å‡† Red-Green-Refactor
tdd_template: standard

# å¯ä»¥æ‰©å±•
tdd_template: custom
custom_phases:
  - name: red
    timeout: 60s
  - name: green
    timeout: 120s
    max_iterations: 5
  - name: integration
    required: true
  - name: refactor
    timeout: 180s
```

### æ’æ§½äºŒï¼šè´¨é‡é—¨æ§›æ‰©å±•

```yaml
# å½“å‰: æµ‹è¯•é€šè¿‡
quality_gate: test_pass

# å¯ä»¥æ‰©å±•
quality_gates:
  - test_pass: true
  - coverage: 80%
  - mutation_score: 70%
  - performance: no_regression
```

### æ’æ§½ä¸‰ï¼šè‡ªåŠ¨ç”Ÿæˆæµ‹è¯•

```yaml
# å½“å‰: æ‰‹åŠ¨å†™æµ‹è¯•
test_generation: manual

# å¯ä»¥æ‰©å±•
test_generation:
  mode: assisted
  ai_suggestions: true
  edge_case_detection: true
```

---

## 6. äº‹æ•…å¤ç›˜æ¡£æ¡ˆ #39

> *æ—¶é—´: 2024-08-14 11:23:45 UTC*
> *å½±å“: ç”Ÿäº§ç¯å¢ƒ Bugï¼Œç”¨æˆ·æ•°æ®æ³„éœ²*

### æ¡ˆæƒ…è¿˜åŸ

**åœºæ™¯**: å›¢é˜Ÿè·³è¿‡ TDDï¼Œç›´æ¥å®ç°äº†ä¸€ä¸ª"ç´§æ€¥"åŠŸèƒ½ã€‚

```markdown
ç´§æ€¥éœ€æ±‚: ç”¨æˆ·å¯†ç é‡ç½®åŠŸèƒ½

å¼€å‘è¿‡ç¨‹:
1. ç›´æ¥å†™ä»£ç : å®ç° password_reset.ts
2. æ‰‹åŠ¨æµ‹è¯•: åœ¨æµè§ˆå™¨é‡Œç‚¹äº†å‡ ä¸ªæŒ‰é’®
3. æäº¤ä»£ç : "åŠŸèƒ½å·²å®Œæˆ"
4. éƒ¨ç½²: ç”Ÿäº§ç¯å¢ƒ

[2 å°æ—¶å]

Bug æŠ¥å‘Š: ç”¨æˆ· A æ”¶åˆ°äº†ç”¨æˆ· B çš„å¯†ç é‡ç½®é‚®ä»¶

è°ƒæŸ¥å‘ç°:
- password_reset å‡½æ•°æ²¡æœ‰éªŒè¯ email å½’å±
- æµ‹è¯•æ²¡æœ‰è¦†ç›–"é‚®ç®±å½’å±éªŒè¯"åœºæ™¯
- æ‰‹åŠ¨æµ‹è¯•ç”¨çš„æ˜¯è‡ªå·±çš„è´¦å·ï¼Œæ²¡æœ‰å‘ç°è¿™ä¸ªé—®é¢˜
```

**æ ¹æœ¬åŸå› **:
- è·³è¿‡äº† TDD çš„ Red Phase
- æ²¡æœ‰å…ˆæ€è€ƒ"ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºé”™"
- æµ‹è¯•åè¡¥ï¼Œåªæµ‹äº†"æ­£å¸¸æµç¨‹"

### ä¿®å¤æªæ–½

1. **å¼ºåˆ¶ TDD**: å®‰å…¨ç›¸å…³åŠŸèƒ½å¿…é¡»é€šè¿‡ TDD
2. **å®‰å…¨æµ‹è¯•æ¸…å•**: æ·»åŠ "æ•°æ®å½’å±éªŒè¯"æ£€æŸ¥
3. **ä»£ç å®¡æŸ¥é‡ç‚¹**: å®‰å…¨ç›¸å…³ä»£ç å¿…é¡»æœ‰è¾¹ç•Œæµ‹è¯•

> **æ•™è®­**:
> *"ç´§æ€¥ä¸æ˜¯è·³è¿‡è´¨é‡çš„å€Ÿå£ã€‚TDD æ˜¯'å®‰å…¨ç½‘'ï¼Œè·³è¿‡å®ƒå°±æ˜¯èµ°é’¢ä¸ã€‚"*

### å¹½çµæ—ç™½ï¼šæµ‹è¯•çš„å‡è±¡

æ­¤äº‹æ•…æ­ç¤ºäº†ä¸€ä¸ªæ›´æ·±å±‚çš„é—®é¢˜ï¼š

```
æµ‹è¯•çš„"å‡ç»¿"ç°è±¡:

åœºæ™¯: å…ˆå†™ä»£ç åè¡¥æµ‹è¯•

1. å†™ä»£ç : å®ç° password_reset(email)
2. è¡¥æµ‹è¯•: 
   it('sends reset email', () => {
     password_reset('user@example.com');
     expect(emailSent).toBe(true);
   });
3. æµ‹è¯•é€šè¿‡: PASS

é—®é¢˜: æµ‹è¯•åªéªŒè¯äº†"å‘é€æˆåŠŸ"ï¼Œæ²¡æœ‰éªŒè¯"å‘ç»™è°"

å¦‚æœå…ˆå†™æµ‹è¯•ï¼ˆTDDï¼‰:
1. æƒ³æµ‹è¯•: "ç»™ user A å‘é‡ç½®é‚®ä»¶"
2. æƒ³æµ‹è¯•: "ä¸åº”è¯¥ç»™ user B å‘ user A çš„é‚®ä»¶"  â† è¿™ä¸ªæµ‹è¯•ä¼šå…ˆå¤±è´¥
3. æ„è¯†åˆ°: éœ€è¦éªŒè¯é‚®ç®±å½’å±
4. å†™ä»£ç : æ·»åŠ é‚®ç®±éªŒè¯é€»è¾‘
```

**å¹½çµçš„ä½è¯­**: å½“ä½ å…ˆå†™ä»£ç åè¡¥æµ‹è¯•æ—¶ï¼Œæµ‹è¯•åªæ˜¯åœ¨"ç¡®è®¤"ä½ å·²ç»å†™å¥½çš„ä»£ç ã€‚å®ƒä¸ä¼šå¸®ä½ å‘ç°ä½ æ²¡è€ƒè™‘åˆ°çš„é—®é¢˜ã€‚å› ä¸ºä½ çš„æµ‹è¯•å—é™äºä½ å·²ç»å†™å¥½çš„ä»£ç ...

---

## é™„å½•

### A. TDD çº¢æ——è­¦å‘Š

```markdown
**Red Flags - STOP and Reassess**:

- ä»£ç å†™åœ¨äº†æµ‹è¯•ä¹‹å‰
- æµ‹è¯•ç«‹å³é€šè¿‡ï¼ˆæ²¡æœ‰è§è¯ Red é˜¶æ®µï¼‰
- ä¸èƒ½è§£é‡Šä¸ºä»€ä¹ˆæµ‹è¯•åº”è¯¥å¤±è´¥
- "Just this once"ï¼ˆå°±è¿™ä¸€æ¬¡ï¼‰çš„å€Ÿå£
- "Tests after achieve same goals"ï¼ˆåè¡¥æµ‹è¯•ä¸€æ ·ï¼‰çš„æƒ³æ³•
```

### B. TDD æ£€æŸ¥æ¸…å•

```markdown
- [ ] æµ‹è¯•åœ¨ä»£ç ä¹‹å‰ç¼–å†™
- [ ] æµ‹è¯•è¿è¡Œåå¤±è´¥ï¼ˆçœŸçº¢ç¯ï¼‰
- [ ] ä»£ç åªä¸ºäº†è®©æµ‹è¯•é€šè¿‡è€Œå†™
- [ ] ç»¿ç¯åè¿›è¡Œäº†é‡æ„
- [ ] é‡æ„åæµ‹è¯•ä»ç„¶é€šè¿‡
- [ ] è¦†ç›–äº†æ­£å¸¸ã€å¼‚å¸¸ã€è¾¹ç•Œæƒ…å†µ
```

### C. ä¸‹ä¸€ç« 

[Chapter 40: å¤šç»´è¿‡æ»¤å™¨ â€” review-cycle çš„ä¸ƒç»´å®¡æŸ¥](./40-review-cycle.md) - åˆ†æå¤šç»´åº¦ä»£ç å®¡æŸ¥ä¸æ·±åº¦è°ƒæŸ¥æœºåˆ¶

---

*ç‰ˆæœ¬: 2.0.0*
*ä¼šè¯: ANL-ccw-architecture-audit-2025-02-17*
*é£æ ¼: "å°è¯´åŒ–" Part XI-B Chapter 39*
*æœ€åæ›´æ–°: Round 1 - workflow-tdd Iron Law*
