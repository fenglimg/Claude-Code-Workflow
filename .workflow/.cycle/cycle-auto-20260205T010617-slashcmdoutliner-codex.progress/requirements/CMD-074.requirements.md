# Requirement (non-leaky): /workflow:layout-extract

## Source

- Command doc (oracle, do not paste full contents into spec): `.claude/commands/workflow/ui-design/layout-extract.md`

## Command Identity

- group: workflow
- name: layout-extract
- description: Extract structural layout information from reference images or text prompts using Claude analysis with variant generation or refinement mode
- argument-hint: [-y|--yes] [--design-id <id>] [--session <id>] [--images "<glob>"] [--prompt "<desc>"] [--targets "<list>"] [--variants <count>] [--device-type <desktop|mobile|tablet|responsive>] [--interactive] [--refine]
- allowed-tools: TodoWrite(*), Read(*), Write(*), Glob(*), Bash(*), AskUserQuestion(*), Task(ui-design-agent), mcp__exa__web_search_exa(*)

## Structure Hints (Headings Only)

  - Auto Mode
- Layout Extraction Command
  - Overview
  - Execution Process
  - Phase 0: Setup & Input Validation
    - Step 1: Detect Input, Mode & Targets
- Detect input source
- Priority: --images → image | --prompt → text
- Detect refinement mode
- Set variants count
- Refinement mode: Force variants_count = 1 (ignore user-provided --variants)
- Exploration mode: Use --variants or default to 3 (range: 1-5)
- Resolve targets
- Priority: --targets → prompt analysis → default ["page"]
- Resolve device type
- Determine base path with priority: --design-id > --session > auto-detect
- Validate and convert to absolute path
    - Step 2: Load Inputs & Create Directories
- For image mode
- For text mode
- Validate --prompt is non-empty
- Create output directory
    - Step 3: Memory Check
- 1. Check if inputs cached in session memory
- 2. Check if output already exists
  - Phase 1: Layout Concept or Refinement Options Generation
    - Step 0.5: Load Existing Layout (Refinement Mode)
    - Step 1: Generate Options (Agent Task 1 - Mode-Specific)
    - Step 2: Verify Options File Created
- Quick validation
  - Phase 1.5: User Confirmation (Optional - Triggered by --interactive)
    - Step 1: Check Interactive Flag
- Skip this entire phase if --interactive flag is not present
- Interactive mode enabled
    - Step 2: Load and Present Options (Mode-Specific)
- Read options file
- Branch based on mode
    - Step 2: Present Options to User (Per Target)
    - Step 3: Capture User Selection and Update Options File (Per Target)
    - Step 4: Confirmation Message
  - Phase 2: Layout Template Generation (Agent Task 2)
    - Step 1: Load User Selections or Default to All
- Read analysis-options.json which may contain user_selection
- Check if user_selection field exists (interactive mode)
- Build task list for all selected concepts across all targets
    - Step 2: Launch Parallel Agent Tasks
    - Step 3: Verify Output Files
- Count generated files
- Verify all files were created
- Verify file structure (sample check)
  - Completion
    - Todo Update
    - Output Message
  - Simple Bash Commands
    - Path Operations
- Find design directory
- Create output directories
    - Validation Commands
- Check if already extracted
- Count generated files
- Validate JSON structure (sample check)
    - File Operations
- Load image references
- Write layout templates
  - Output Structure
  - Layout Template File Format
  - Error Handling
    - Common Errors
    - Recovery Strategies
  - Key Features

## Hard Constraints (P0)

- Do not claim a pointer is `Existing` unless it is verifiable in the repo now.
- Evidence must be dual-source: docs (.claude/commands/**.md) + ts (ccw/src/**).
- If unsure, mark as `Planned` and add a concrete `Verify` step.
